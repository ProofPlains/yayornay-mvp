<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HappySnap - Instant Customer Feedback with QR Codes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container, .welcome-container, .signup-container, .login-container, .admin-container {
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .container { max-width: 400px; }
        .welcome-container { max-width: 600px; padding: 40px; text-align: center; }
        .signup-container, .login-container { max-width: 500px; padding: 40px; }
        .admin-container { max-width: 1200px; padding: 30px; }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 24px; margin-bottom: 10px; }

        .location-display {
            margin-top: 15px;
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            font-weight: 500;
        }

        .feedback-section { padding: 40px 30px; text-align: center; }
        .feedback-question { font-size: 20px; margin-bottom: 30px; color: #333; }

        .emoji-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 30px;
            flex-wrap: nowrap;
            padding: 0 10px;
        }

        .emoji-btn {
            background: none;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            width: 65px;
            height: 65px;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 1;
            min-width: 40px;
            min-height: 40px;
        }

        .emoji-btn:hover { transform: scale(1.1); border-color: #667eea; }
        .emoji-btn.selected { border-color: #667eea; background: #667eea; color: white; }

        .emoji-btn[data-sentiment="very-happy"]::after { content: "üòç"; }
        .emoji-btn[data-sentiment="happy"]::after { content: "üòä"; }
        .emoji-btn[data-sentiment="neutral"]::after { content: "üòê"; }
        .emoji-btn[data-sentiment="sad"]::after { content: "üòû"; }
        .emoji-btn[data-sentiment="very-sad"]::after { content: "üò≠"; }

        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .submit-btn.enabled { opacity: 1; pointer-events: auto; }

        .thank-you { display: none; padding: 40px; text-align: center; }
        .thank-you h2 { color: #4caf50; margin-bottom: 15px; }

        .logo { font-size: 48px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .tagline { font-size: 20px; color: #666; margin-bottom: 30px; }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 40px 0;
            text-align: center;
        }

        .feature { padding: 20px; background: #f8f9fa; border-radius: 15px; }
        .feature-icon { font-size: 36px; margin-bottom: 10px; }
        .feature h3 { font-size: 16px; color: #333; margin-bottom: 8px; }
        .feature p { font-size: 14px; color: #666; }

        .cta-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 13px 28px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-title { text-align: center; color: #333; margin-bottom: 30px; }
        .form-title h2 { font-size: 28px; margin-bottom: 8px; }
        .form-title p { color: #666; font-size: 16px; }

        .verification-message {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .error-message {
            background: #ffeaa7;
            border: 1px solid #fdcb6e;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            color: #856404;
        }

        .nav-tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 30px; }
        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-tab.active { color: #667eea; border-bottom-color: #667eea; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number { font-size: 36px; font-weight: bold; margin-bottom: 10px; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        .btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .qr-section { background: #f8f9fa; padding: 30px; border-radius: 15px; text-align: center; margin-top: 20px; }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .admin-toggle:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .location-info {
            flex-grow: 1;
        }

        .location-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            background: #5a6fd8;
        }

        .btn-small.btn-danger {
            background: #e74c3c;
        }

        .btn-small.btn-danger:hover {
            background: #c0392b;
        }

        .edit-input {
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            margin-right: 8px;
            min-width: 200px;
        }

        .edit-input:focus {
            outline: none;
            border-color: #5a6fd8;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #e74c3c;
            color: white;
            border: 2px solid #c0392b;
            padding: 10px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
            border-color: #a93226;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
        }

        .link-button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }

        .link-button:hover {
            color: #5a6fd8;
        }

        @media (max-width: 480px) {
            .emoji-btn { width: 50px; height: 50px; font-size: 24px; border-width: 2px; }
            .cta-buttons { flex-direction: column; align-items: center; }
            .features { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-container">
        <div class="logo">HappySnap</div>
        <div class="tagline">Instant customer feedback with QR codes</div>
        
        <div class="features">
            <div class="feature">
                <div class="feature-icon">üì±</div>
                <h3>QR Code Magic</h3>
                <p>Customers scan, rate instantly</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üìä</div>
                <h3>Live Analytics</h3>
                <p>Real-time sentiment tracking</p>
            </div>
            <div class="feature">
                <div class="feature-icon">üè™</div>
                <h3>Multi-Location</h3>
                <p>Manage all your venues</p>
            </div>
        </div>

        <div class="cta-buttons">
            <button class="btn-primary" onclick="showSignup()">Sign Up</button>
            <button class="btn-secondary" onclick="showDemo()">See Demo</button>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="link-button" onclick="showLogin()">Already have an account? Log in</button>
        </div>
    </div>

    <!-- Sign Up Form -->
    <div id="signupScreen" class="signup-container" style="display: none;">
        <div class="form-title">
            <h2>Create Your Free Account</h2>
            <p>Start collecting feedback in minutes</p>
        </div>

        <div id="signupError" class="error-message" style="display: none;"></div>

        <form id="signupForm" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label for="businessName">Business Name</label>
                <input type="text" id="businessName" required>
            </div>
            <div class="form-group">
                <label for="ownerName">Your Name</label>
                <input type="text" id="ownerName" required>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required minlength="6">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" required minlength="6">
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Create Account</button>
        </form>

        <div style="text-align: center; margin-top: 20px;">
            <button class="link-button" onclick="showWelcome()">‚Üê Back to welcome</button>
            <span style="color: #ccc; margin: 0 10px;">|</span>
            <button class="link-button" onclick="showLogin()">Already have an account?</button>
        </div>
    </div>

    <!-- Login Form -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <div class="form-title">
            <h2>Welcome Back</h2>
            <p>Log in to your HappySnap account</p>
        </div>

        <div id="loginError" class="error-message" style="display: none;"></div>

        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Log In</button>
        </form>

        <div style="text-align: center; margin-top: 20px;">
            <button class="link-button" onclick="showWelcome()">‚Üê Back to welcome</button>
            <span style="color: #ccc; margin: 0 10px;">|</span>
            <button class="link-button" onclick="showSignup()">Need an account? Sign up</button>
        </div>
    </div>

    <!-- Customer Feedback View -->
    <div id="customerView" class="container" style="display: none;">
        <!-- Admin toggle button for logged-in users -->
        <button id="customerAdminToggle" class="admin-toggle" onclick="toggleView()" style="display: none;">View as Admin</button>
        <button id="customerLogoutBtn" class="logout-btn" onclick="logout()" style="display: none;">Logout</button>

        <div class="header">
            <h1>How was your experience?</h1>
            <div class="location-display">
                <span id="customerLocationDisplay"></span>
            </div>
        </div>
        
        <div class="feedback-section">
            <div class="feedback-question">
                Please rate your experience with us today
            </div>
            
            <div class="emoji-buttons">
                <button class="emoji-btn" data-sentiment="very-happy" onclick="selectSentiment('very-happy', this)"></button>
                <button class="emoji-btn" data-sentiment="happy" onclick="selectSentiment('happy', this)"></button>
                <button class="emoji-btn" data-sentiment="neutral" onclick="selectSentiment('neutral', this)"></button>
                <button class="emoji-btn" data-sentiment="sad" onclick="selectSentiment('sad', this)"></button>
                <button class="emoji-btn" data-sentiment="very-sad" onclick="selectSentiment('very-sad', this)"></button>
            </div>
            
            <button class="submit-btn" onclick="submitFeedback()">Submit Feedback</button>
        </div>
        
        <div class="thank-you" id="thankYou">
            <h2>Thank you for your feedback! üéâ</h2>
            <p>Your opinion helps us improve our service.</p>
        </div>
    </div>

    <!-- Admin View -->
    <div id="adminView" class="admin-container" style="display: none;">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <button class="admin-toggle" onclick="toggleView()">View as Customer</button>

        <h1>Sentiment Analytics Dashboard</h1>
        <p style="color: #666; margin-bottom: 30px;">Welcome back, <span id="dashboardOwnerName"></span>!</p>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('analytics')">Analytics</button>
            <button class="nav-tab" onclick="switchTab('locations')">Locations</button>
            <button class="nav-tab" onclick="switchTab('qr')">QR Codes</button>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content active">
            <div style="margin-bottom: 20px;">
                <label>Select Location: </label>
                <select id="analyticsLocationSelect" onchange="updateAnalytics()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalFeedback">0</div>
                    <div class="stat-label">Total Feedback</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="veryHappyPercent">0%</div>
                    <div class="stat-label">Very Happy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="happyPercent">0%</div>
                    <div class="stat-label">Happy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="neutralPercent">0%</div>
                    <div class="stat-label">Neutral</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sadPercent">0%</div>
                    <div class="stat-label">Sad</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="verySadPercent">0%</div>
                    <div class="stat-label">Very Sad</div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>Recent Feedback</h3>
                <div id="recentFeedbackList"></div>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content">
            <div style="margin-bottom: 30px;">
                <input type="text" id="newLocationInput" placeholder="Enter location name" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-right: 10px; width: 200px;">
                <button class="btn" onclick="addLocation()">Add Location</button>
            </div>
            
            <div id="locationsList"></div>
        </div>

        <!-- QR Codes Tab -->
        <div id="qr" class="tab-content">
            <div style="margin-bottom: 20px;">
                <label>Generate QR Code for: </label>
                <select id="qrLocationSelect" onchange="generateQR()">
                </select>
            </div>
            
            <div class="qr-section">
                <h3>QR Code Sign Generator</h3>
                <div id="qrContainer"></div>
                <p>Generate a complete sign with call-to-action text</p>
                <button class="btn" onclick="generateSign()">Generate Customer Sign</button>
                <div id="generatedSign" style="display: none; margin-top: 20px; text-align: center;">
                    <h4>Your Customer Sign is Ready!</h4>
                    <p style="color: #666; margin-bottom: 15px;">Right-click on the image below and select "Save image as..." to download</p>
                    <div id="signImageContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var currentView = 'welcome';
        var selectedSentiment = null;
        var currentLocation = 'main';
        var currentUser = null;

        // Simulate a simple user database
        var userDatabase = {};

        function showWelcome() {
            hideAllScreens();
            hideAdminControls();
            document.getElementById('welcomeScreen').style.display = 'block';
            currentView = 'welcome';
        }

        function showSignup() {
            hideAllScreens();
            hideAdminControls();
            document.getElementById('signupScreen').style.display = 'block';
            currentView = 'signup';
            clearFormErrors();
        }

        function showLogin() {
            hideAllScreens();
            hideAdminControls();
            document.getElementById('loginScreen').style.display = 'block';
            currentView = 'login';
            clearFormErrors();
        }

        function showDemo() {
            hideAllScreens();
            document.getElementById('customerView').style.display = 'block';
            
            var demoLocations = {
                'demo': { 
                    name: 'Demo Restaurant', 
                    feedback: [
                        { sentiment: 'very-happy', timestamp: new Date(Date.now() - 3600000).toISOString(), location: 'demo' },
                        { sentiment: 'happy', timestamp: new Date(Date.now() - 7200000).toISOString(), location: 'demo' },
                        { sentiment: 'neutral', timestamp: new Date(Date.now() - 10800000).toISOString(), location: 'demo' },
                        { sentiment: 'sad', timestamp: new Date(Date.now() - 14400000).toISOString(), location: 'demo' }
                    ]
                }
            };
            
            window.demoAccount = {
                userId: 'demo',
                businessName: 'Demo Business',
                ownerName: 'Demo User',
                locations: demoLocations,
                createdAt: new Date().toISOString()
            };
            
            currentLocation = 'demo';
            updateCustomerLocationDisplay(demoLocations);
            // Show only admin toggle for demo mode (no logout button)
            showDemoControls();
            currentView = 'customer-demo';
        }

        function hideAllScreens() {
            var screens = ['welcomeScreen', 'signupScreen', 'loginScreen', 'customerView', 'adminView'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).style.display = 'none';
            }
        }

        function hideAdminControls() {
            // Hide admin controls when not logged in
            var customerToggle = document.getElementById('customerAdminToggle');
            var customerLogout = document.getElementById('customerLogoutBtn');
            if (customerToggle) customerToggle.style.display = 'none';
            if (customerLogout) customerLogout.style.display = 'none';
        }

        function showAdminControls() {
            // Show admin controls when logged in as admin
            var customerToggle = document.getElementById('customerAdminToggle');
            var customerLogout = document.getElementById('customerLogoutBtn');
            if (customerToggle) customerToggle.style.display = 'flex';
            if (customerLogout) customerLogout.style.display = 'block';
        }

        function showDemoControls() {
            // Show only admin toggle for demo mode (no logout button)
            var customerToggle = document.getElementById('customerAdminToggle');
            var customerLogout = document.getElementById('customerLogoutBtn');
            if (customerToggle) customerToggle.style.display = 'flex';
            if (customerLogout) customerLogout.style.display = 'none';
        }

        function clearFormErrors() {
            var errorElements = ['signupError', 'loginError'];
            for (var i = 0; i < errorElements.length; i++) {
                var element = document.getElementById(errorElements[i]);
                if (element) {
                    element.style.display = 'none';
                    element.textContent = '';
                }
            }
        }

        function showError(elementId, message) {
            var element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            showWelcome();
        });

        function handleSignup(event) {
            if (event) {
                event.preventDefault();
            }
            
            var businessName = document.getElementById('businessName').value.trim();
            var ownerName = document.getElementById('ownerName').value.trim();
            var email = document.getElementById('email').value.trim().toLowerCase();
            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmPassword').value;

            // Clear previous errors
            clearFormErrors();

            // Validation
            if (!businessName || !ownerName || !email || !password || !confirmPassword) {
                showError('signupError', 'Please fill in all fields');
                return false;
            }

            if (password !== confirmPassword) {
                showError('signupError', 'Passwords do not match');
                return false;
            }

            if (password.length < 6) {
                showError('signupError', 'Password must be at least 6 characters long');
                return false;
            }

            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('signupError', 'Please enter a valid email address');
                return false;
            }

            if (userDatabase[email]) {
                showError('signupError', 'An account with this email already exists');
                return false;
            }

            // Create new user
            var userId = 'user_' + Date.now();
            var newUser = {
                userId: userId,
                businessName: businessName,
                ownerName: ownerName,
                email: email,
                password: password, // In real app, this would be hashed
                locations: {
                    'main': { name: businessName + ' - Main Location', feedback: [] }
                },
                createdAt: new Date().toISOString()
            };

            userDatabase[email] = newUser;
            currentUser = newUser;
            currentLocation = 'main';

            // Show admin dashboard
            showAdminDashboard();
            return false;
        }

        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            var email = document.getElementById('loginEmail').value.trim().toLowerCase();
            var password = document.getElementById('loginPassword').value;

            // Clear previous errors
            clearFormErrors();

            if (!email || !password) {
                showError('loginError', 'Please enter both email and password');
                return false;
            }

            var user = userDatabase[email];
            if (!user || user.password !== password) {
                showError('loginError', 'Invalid email or password');
                return false;
            }

            currentUser = user;
            currentLocation = Object.keys(user.locations)[0] || 'main';
            showAdminDashboard();
            return false;
        }

        function showAdminDashboard() {
            hideAllScreens();
            document.getElementById('adminView').style.display = 'block';
            document.getElementById('dashboardOwnerName').textContent = currentUser.ownerName;
            currentView = 'admin';
            
            updateLocationSelects();
            updateAnalytics();
            generateQR();
        }

        function logout() {
            currentUser = null;
            currentLocation = 'main';
            showWelcome();
        }

        function updateCustomerLocationDisplay(locations) {
            var display = document.getElementById('customerLocationDisplay');
            if (!display) return;

            var locationName = locations[currentLocation] ? locations[currentLocation].name : 'Unknown Location';
            display.textContent = locationName;
        }

        function selectSentiment(sentiment, button) {
            var buttons = document.querySelectorAll('.emoji-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('selected');
            }
            
            button.classList.add('selected');
            selectedSentiment = sentiment;
            
            var submitBtn = document.querySelector('.submit-btn');
            submitBtn.classList.add('enabled');
        }

        function submitFeedback() {
            if (!selectedSentiment) return;
            
            var feedback = {
                sentiment: selectedSentiment,
                timestamp: new Date().toISOString(),
                location: currentLocation
            };

            if (currentView === 'customer-demo' && window.demoAccount) {
                if (!window.demoAccount.locations[currentLocation].feedback) {
                    window.demoAccount.locations[currentLocation].feedback = [];
                }
                window.demoAccount.locations[currentLocation].feedback.push(feedback);
            }

            document.querySelector('.feedback-section').style.display = 'none';
            document.getElementById('thankYou').style.display = 'block';
            
            if (currentView === 'customer-demo') {
                setTimeout(function() {
                    showDemoAdmin();
                }, 2000);
            }
        }

        function showDemoAdmin() {
            hideAllScreens();
            document.getElementById('adminView').style.display = 'block';
            document.getElementById('dashboardOwnerName').textContent = 'Demo User';
            
            // Hide logout button in demo mode
            var logoutBtn = document.querySelector('#adminView .logout-btn');
            if (logoutBtn) logoutBtn.style.display = 'none';
            
            currentView = 'admin-demo';
            
            var dashboard = document.getElementById('adminView');
            if (!document.getElementById('demoNotice')) {
                var notice = document.createElement('div');
                notice.id = 'demoNotice';
                notice.style.cssText = 'background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;';
                notice.innerHTML = '<p style="color: #2e7d32; margin: 0 0 10px 0;"><strong>Demo Mode</strong> - This is what business owners see!</p><button onclick="showWelcome()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">‚Üê Back to Welcome</button>';
                dashboard.insertBefore(notice, dashboard.firstChild);
            }
            
            updateLocationSelects();
            updateAnalytics();
            generateQR();
        }

        function updateLocationSelects() {
            var locations = currentUser ? currentUser.locations : (window.demoAccount ? window.demoAccount.locations : {});
            
            var selects = [
                document.getElementById('analyticsLocationSelect'),
                document.getElementById('qrLocationSelect'),
                document.getElementById('customerLocationSelect')
            ];
            
            for (var i = 0; i < selects.length; i++) {
                var select = selects[i];
                if (!select) continue;
                
                try {
                    if (select.id === 'analyticsLocationSelect') {
                        select.innerHTML = '<option value="all">All Locations</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    
                    for (var id in locations) {
                        var option = document.createElement('option');
                        option.value = id;
                        option.textContent = locations[id].name;
                        if (select.id === 'customerLocationSelect' && id === currentLocation) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                } catch (error) {
                    console.log('Error updating select:', select.id, error);
                }
            }
        }

        function updateAnalytics() {
            var locations = currentUser ? currentUser.locations : (window.demoAccount ? window.demoAccount.locations : {});
            var selectedLocationElement = document.getElementById('analyticsLocationSelect');
            var selectedLocation = selectedLocationElement ? selectedLocationElement.value : 'all';
            var allFeedback = [];
            
            if (selectedLocation === 'all') {
                for (var locId in locations) {
                    var location = locations[locId];
                    if (location.feedback) {
                        allFeedback = allFeedback.concat(location.feedback);
                    }
                }
            } else if (locations[selectedLocation] && locations[selectedLocation].feedback) {
                allFeedback = locations[selectedLocation].feedback;
            }
            
            var total = allFeedback.length;
            var veryHappy = 0, happy = 0, neutral = 0, sad = 0, verySad = 0;
            
            for (var i = 0; i < allFeedback.length; i++) {
                var sentiment = allFeedback[i].sentiment;
                if (sentiment === 'very-happy') veryHappy++;
                else if (sentiment === 'happy') happy++;
                else if (sentiment === 'neutral') neutral++;
                else if (sentiment === 'sad') sad++;
                else if (sentiment === 'very-sad') verySad++;
            }
            
            var elements = {
                'totalFeedback': total,
                'veryHappyPercent': total > 0 ? Math.round((veryHappy / total) * 100) + '%' : '0%',
                'happyPercent': total > 0 ? Math.round((happy / total) * 100) + '%' : '0%',
                'neutralPercent': total > 0 ? Math.round((neutral / total) * 100) + '%' : '0%',
                'sadPercent': total > 0 ? Math.round((sad / total) * 100) + '%' : '0%',
                'verySadPercent': total > 0 ? Math.round((verySad / total) * 100) + '%' : '0%'
            };
            
            for (var elementId in elements) {
                var element = document.getElementById(elementId);
                if (element) {
                    element.textContent = elements[elementId];
                }
            }
            
            updateRecentFeedback(allFeedback);
        }

        function updateRecentFeedback(feedback) {
            var container = document.getElementById('recentFeedbackList');
            if (!container) return;
            
            container.innerHTML = '';
            
            var recent = feedback.slice(-10).reverse();
            var locations = currentUser ? currentUser.locations : (window.demoAccount ? window.demoAccount.locations : {});
            
            for (var i = 0; i < recent.length; i++) {
                var item = recent[i];
                var div = document.createElement('div');
                div.className = 'feedback-item';
                
                var emoji = item.sentiment === 'very-happy' ? 'üòç' : 
                           item.sentiment === 'happy' ? 'üòä' : 
                           item.sentiment === 'neutral' ? 'üòê' : 
                           item.sentiment === 'sad' ? 'üòû' : 'üò≠';
                
                var time = new Date(item.timestamp).toLocaleString();
                var locationName = locations[item.location] ? locations[item.location].name : 'Unknown';
                
                div.innerHTML = '<span style="font-size: 24px;">' + emoji + '</span><span>' + locationName + '</span><span style="color: #666; font-size: 14px;">' + time + '</span>';
                container.appendChild(div);
            }
        }

        function addLocation() {
            if (!currentUser) return;
            
            var input = document.getElementById('newLocationInput');
            var name = input.value.trim();
            if (!name) return;
            
            var id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (currentUser.locations[id]) {
                alert('A location with this name already exists');
                return;
            }
            
            currentUser.locations[id] = {
                name: name,
                feedback: []
            };
            
            input.value = '';
            updateLocationSelects();
            updateLocationsList();
        }

        function updateLocationsList() {
            var container = document.getElementById('locationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (currentView === 'admin-demo' && window.demoAccount) {
                var demoLocationsData = [
                    { name: 'Demo Restaurant', feedback: window.demoAccount.locations.demo.feedback.length },
                    { name: 'Main Street Cafe', feedback: 12 },
                    { name: 'Downtown Store', feedback: 8 }
                ];
                
                for (var i = 0; i < demoLocationsData.length; i++) {
                    var location = demoLocationsData[i];
                    var div = document.createElement('div');
                    div.className = 'location-item';
                    div.innerHTML = '<div class="location-info"><span>' + location.name + '</span><br><span style="color: #666; font-size: 14px;">' + location.feedback + ' feedback entries</span></div>';
                    container.appendChild(div);
                }
                
                var notice = document.createElement('div');
                notice.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px; text-align: center;';
                notice.innerHTML = '<p style="color: #856404; margin: 0;"><strong>Demo Mode:</strong> Location management is available in the full version</p>';
                container.appendChild(notice);
            } else if (currentUser) {
                for (var id in currentUser.locations) {
                    var location = currentUser.locations[id];
                    var div = document.createElement('div');
                    div.className = 'location-item';
                    div.innerHTML = 
                        '<div class="location-info">' +
                            '<span id="location-name-' + id + '">' + location.name + '</span>' +
                            '<br><span style="color: #666; font-size: 14px;">' + (location.feedback ? location.feedback.length : 0) + ' feedback entries</span>' +
                        '</div>' +
                        '<div class="location-actions">' +
                            '<button class="btn-small" onclick="editLocation(\'' + id + '\')">Edit</button>' +
                            '<button class="btn-small btn-danger" onclick="removeLocation(\'' + id + '\')">Remove</button>' +
                        '</div>';
                    container.appendChild(div);
                }
            }
        }

        function editLocation(locationId) {
            if (!currentUser || !currentUser.locations[locationId]) return;
            
            var nameSpan = document.getElementById('location-name-' + locationId);
            var currentName = currentUser.locations[locationId].name;
            
            // Create input field
            var input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'edit-input';
            input.id = 'edit-input-' + locationId;
            
            // Create save button
            var saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'btn-small';
            saveBtn.style.marginLeft = '8px';
            saveBtn.onclick = function() { saveLocationEdit(locationId); };
            
            // Create cancel button
            var cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-small btn-danger';
            cancelBtn.style.marginLeft = '4px';
            cancelBtn.onclick = function() { cancelLocationEdit(locationId); };
            
            // Replace name with input and buttons
            nameSpan.innerHTML = '';
            nameSpan.appendChild(input);
            nameSpan.appendChild(saveBtn);
            nameSpan.appendChild(cancelBtn);
            
            // Focus input and select text
            input.focus();
            input.select();
            
            // Handle Enter key
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveLocationEdit(locationId);
                }
            });
            
            // Handle Escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cancelLocationEdit(locationId);
                }
            });
        }

        function saveLocationEdit(locationId) {
            if (!currentUser || !currentUser.locations[locationId]) return;
            
            var input = document.getElementById('edit-input-' + locationId);
            var newName = input.value.trim();
            
            if (!newName) {
                alert('Location name cannot be empty');
                input.focus();
                return;
            }
            
            // Check if name already exists (excluding current location)
            for (var id in currentUser.locations) {
                if (id !== locationId && currentUser.locations[id].name === newName) {
                    alert('A location with this name already exists');
                    input.focus();
                    return;
                }
            }
            
            // Update location name
            currentUser.locations[locationId].name = newName;
            
            // Refresh the locations list and other selects
            updateLocationsList();
            updateLocationSelects();
        }

        function cancelLocationEdit(locationId) {
            if (!currentUser || !currentUser.locations[locationId]) return;
            
            // Simply refresh the locations list to restore original display
            updateLocationsList();
        }

        function removeLocation(locationId) {
            if (!currentUser || !currentUser.locations[locationId]) return;
            
            var locationName = currentUser.locations[locationId].name;
            var feedbackCount = currentUser.locations[locationId].feedback ? currentUser.locations[locationId].feedback.length : 0;
            
            // Prevent removing the last location
            var locationCount = Object.keys(currentUser.locations).length;
            if (locationCount <= 1) {
                alert('You must have at least one location. Add another location before removing this one.');
                return;
            }
            
            // Confirm deletion
            var confirmMessage = 'Are you sure you want to remove "' + locationName + '"?';
            if (feedbackCount > 0) {
                confirmMessage += '\n\nThis location has ' + feedbackCount + ' feedback entries that will be permanently deleted.';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Remove the location
            delete currentUser.locations[locationId];
            
            // If we were currently viewing this location, switch to the first available location
            if (currentLocation === locationId) {
                currentLocation = Object.keys(currentUser.locations)[0];
            }
            
            // Refresh everything
            updateLocationsList();
            updateLocationSelects();
            updateAnalytics();
        }

        function generateQR() {
            var locations = currentUser ? currentUser.locations : (window.demoAccount ? window.demoAccount.locations : {});
            var qrSelect = document.getElementById('qrLocationSelect');
            var selectedLocation = currentLocation;
            
            if (qrSelect && qrSelect.value) {
                selectedLocation = qrSelect.value;
            } else if (Object.keys(locations).length > 0) {
                selectedLocation = Object.keys(locations)[0];
            }
            
            var container = document.getElementById('qrContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            var canvas = document.createElement('canvas');
            var qr = new QRious({
                element: canvas,
                value: window.location.origin + window.location.pathname + '?location=' + selectedLocation,
                size: 200,
                background: 'white',
                foreground: 'black'
            });
            
            container.appendChild(canvas);
        }

        function generateSign() {
            var locations = currentUser ? currentUser.locations : (window.demoAccount ? window.demoAccount.locations : {});
            var qrSelect = document.getElementById('qrLocationSelect');
            var selectedLocation = currentLocation;
            
            if (qrSelect && qrSelect.value) {
                selectedLocation = qrSelect.value;
            } else if (Object.keys(locations).length > 0) {
                selectedLocation = Object.keys(locations)[0];
            }
            
            var locationName = locations[selectedLocation] ? locations[selectedLocation].name : 'Unknown Location';
            var canvas = document.querySelector('#qrContainer canvas');
            
            if (!canvas) {
                alert('Please generate a QR code first');
                return;
            }

            try {
                // Create a new canvas for the full sign
                var signCanvas = document.createElement('canvas');
                var ctx = signCanvas.getContext('2d');
                
                // Set canvas size (8.5" x 11" at 150 DPI)
                signCanvas.width = 1275;
                signCanvas.height = 1650;
                
                // Background - light beige
                ctx.fillStyle = '#f5f5f0';
                ctx.fillRect(0, 0, signCanvas.width, signCanvas.height);
                
                // Main card with orange border
                var cardMargin = 60;
                var cardX = cardMargin;
                var cardY = 80;
                var cardWidth = signCanvas.width - (cardMargin * 2);
                var cardHeight = signCanvas.height - 160;
                var borderRadius = 40;
                
                // Orange border
                ctx.fillStyle = '#e67e22';
                ctx.beginPath();
                ctx.roundRect(cardX, cardY, cardWidth, cardHeight, borderRadius);
                ctx.fill();
                
                // White inner card
                var innerMargin = 12;
                var innerX = cardX + innerMargin;
                var innerY = cardY + innerMargin;
                var innerWidth = cardWidth - (innerMargin * 2);
                var innerHeight = cardHeight - (innerMargin * 2);
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.roundRect(innerX, innerY, innerWidth, innerHeight, borderRadius - 8);
                ctx.fill();
                
                // HappySnap logo area
                var logoY = innerY + 120;
                
                // Draw smiley face circle (outline only)
                var smileyX = signCanvas.width / 2 - 280;
                var smileyY = logoY;
                var smileyRadius = 60;
                
                // Smiley face circle outline
                ctx.strokeStyle = '#e67e22';
                ctx.lineWidth = 12;
                ctx.beginPath();
                ctx.arc(smileyX, smileyY, smileyRadius, 0, 2 * Math.PI);
                ctx.stroke();
                
                // Smiley eyes (filled orange dots)
                ctx.fillStyle = '#e67e22';
                ctx.beginPath();
                ctx.arc(smileyX - 20, smileyY - 15, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(smileyX + 20, smileyY - 15, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Smiley mouth (orange curved line)
                ctx.strokeStyle = '#e67e22';
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.arc(smileyX, smileyY - 5, 40, 0.15 * Math.PI, 0.85 * Math.PI);
                ctx.stroke();
                
                // "HappySnap" text
                ctx.fillStyle = '#e67e22';
                ctx.font = 'bold 120px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText('HappySnap', smileyX + 120, smileyY);
                
                // Main question
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 110px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                var questionY = logoY + 220;
                ctx.fillText('HOW WAS YOUR', signCanvas.width / 2, questionY);
                ctx.fillText('EXPERIENCE?', signCanvas.width / 2, questionY + 130);
                
                // QR code area
                var qrAreaY = questionY + 280;
                var qrDisplaySize = 350;
                var qrX = signCanvas.width / 2 - qrDisplaySize / 2;
                var qrY = qrAreaY;
                
                // Draw QR code
                ctx.drawImage(canvas, qrX, qrY, qrDisplaySize, qrDisplaySize);
                
                // Location name below QR code
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(locationName, signCanvas.width / 2, qrY + qrDisplaySize + 60);
                
                // "SCAN TO RATE" button
                var buttonY = qrY + qrDisplaySize + 140;
                var buttonWidth = 500;
                var buttonHeight = 100;
                var buttonX = signCanvas.width / 2 - buttonWidth / 2;
                
                ctx.fillStyle = '#e67e22';
                ctx.beginPath();
                ctx.roundRect(buttonX, buttonY, buttonWidth, buttonHeight, 50);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 52px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('SCAN TO RATE', signCanvas.width / 2, buttonY + buttonHeight / 2);
                
                // Convert to data URL and display
                var dataURL = signCanvas.toDataURL('image/png');
                
                // Create image element
                var img = document.createElement('img');
                img.src = dataURL;
                img.style.maxWidth = '100%';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '10px';
                img.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
                img.alt = 'HappySnap Customer Feedback Sign for ' + locationName;
                
                // Show the generated sign
                var signContainer = document.getElementById('generatedSign');
                var imageContainer = document.getElementById('signImageContainer');
                
                imageContainer.innerHTML = '';
                imageContainer.appendChild(img);
                signContainer.style.display = 'block';
                
                // Scroll to the generated sign
                signContainer.scrollIntoView({ behavior: 'smooth' });
                
                console.log('HappySnap sign generated successfully');
                
            } catch (error) {
                console.error('Error generating sign:', error);
                alert('Error generating sign: ' + error.message);
            }
        }

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.nav-tab');
            var contents = document.querySelectorAll('.tab-content');
            
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'locations') {
                updateLocationsList();
            } else if (tabName === 'qr') {
                generateQR();
            }
        }

        function toggleView() {
            if (currentView === 'admin' || currentView === 'admin-demo') {
                if (currentView === 'admin-demo') {
                    hideAllScreens();
                    document.getElementById('customerView').style.display = 'block';
                    showDemoControls(); // Show only toggle button for demo
                    updateCustomerLocationDisplay(window.demoAccount.locations);
                    currentView = 'customer-demo';
                } else {
                    // For real accounts, sync the selected location from analytics dropdown
                    var analyticsSelect = document.getElementById('analyticsLocationSelect');
                    if (analyticsSelect && analyticsSelect.value !== 'all') {
                        currentLocation = analyticsSelect.value;
                    } else if (analyticsSelect && analyticsSelect.value === 'all') {
                        // If "all" is selected, use the first available location
                        currentLocation = Object.keys(currentUser.locations)[0];
                    }
                    
                    hideAllScreens();
                    document.getElementById('customerView').style.display = 'block';
                    updateCustomerLocationDisplay(currentUser.locations);
                    showAdminControls(); // Show admin controls on customer view for logged-in users
                    currentView = 'customer';
                }
            } else {
                if (currentView === 'customer-demo') {
                    showDemoAdmin();
                } else if (currentUser) {
                    showAdminDashboard();
                }
            }
        }

        function switchCustomerLocation() {
            // This function is no longer needed since customers can't switch locations
            // Location is determined by the QR code they scan
        }
    </script>
</body>
</html>
